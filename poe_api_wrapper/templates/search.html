<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Busca de Chats</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown.min.css">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            line-height: 1.6;
            color: #333;
        }
        .search-summary { 
            background-color: #f4f4f4; 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 5px;
        }
        .result { 
            border: 1px solid #e1e4e8; 
            margin-bottom: 15px; 
            padding: 15px; 
            border-radius: 5px;
            background-color: #fff;
        }
        .result-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #e1e4e8;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        .result-title { 
            margin: 0; 
            font-size: 1.2em;
            color: #24292e;
        }
        .result-links { display: flex; gap: 10px; }
        .result-link { 
            color: #0366d6; 
            text-decoration: none; 
            font-weight: 600;
        }
        .result-link:hover { text-decoration: underline; }
        .occurrences { 
            color: #6a737d; 
            font-size: 0.9em; 
            margin-bottom: 10px;
        }
        .message-content {
            background-color: #f6f8fa;
            padding: 15px;
            border-radius: 5px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Mono, Helvetica, Arial, sans-serif;
        }
        .message-content .markdown-body {
            background-color: transparent;
            padding: 0;
        }
        .message-content pre {
            background-color: #f6f8fa !important;
            border: 1px solid #e1e4e8;
            border-radius: 3px;
            padding: 10px;
            overflow-x: auto;
            font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.9em;
            line-height: 1.45;
        }
        .message-content .unsupported-diagram {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px;
            border: 1px solid #ffeeba;
            border-radius: 4px;
            margin: 10px 0;
        }
        .message-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 15px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        /* Garantir que o código seja exibido corretamente */
        pre {
            background-color: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
        }
        pre code {
            white-space: pre;
            word-wrap: normal;
        }
    </style>
</head>
<body>
    <h1>Busca de Chats</h1>
    
    <form method="get" action="/search">
        <input type="text" name="query" value="{{ request.args.get('query', '') }}" placeholder="Buscar chats...">
        <input type="text" name="bot" value="{{ request.args.get('bot', '') }}" placeholder="Filtrar por bot (opcional)">
        <button type="submit">Buscar</button>
    </form>

    {% if results %}
    <div class="search-summary">
        <h2>Resultados da Busca</h2>
        <p>Termo: "{{ query }}"</p>
        <p>Bots selecionados: {{ 'Todos' if not request.args.get('bot') else request.args.get('bot') }}</p>
        <p>Total de resultados: {{ total_results }}</p>
    </div>
    
    {% for result in results %}
    <div class="result">
        <div class="result-header">
            <h2 class="result-title">{{ result.chat_title }} ({{ result.bot_name }})</h2>
            <div class="result-links">
                <a href="{{ result.view_url }}" target="_blank" class="result-link">Ver Chat Completo</a>
            </div>
        </div>
        <div class="occurrences">
            Ocorrências: {{ result.occurrences }}
        </div>
        
        {% for message in result.messages %}
            {% if message.get('text') %}
            <div class="message-content">
                <div class="markdown-body">
                    {{ message.text | safe }}
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endfor %}

    <div class="pagination">
        {% if page > 1 %}
            <a href="{{ request.path }}?query={{ request.args.get('query') }}&bot={{ request.args.get('bot', '') }}&page={{ page - 1 }}">Anterior</a>
        {% endif %}
        
        {% if page < total_pages %}
            <a href="{{ request.path }}?query={{ request.args.get('query') }}&bot={{ request.args.get('bot', '') }}&page={{ page + 1 }}">Próxima</a>
        {% endif %}
    </div>
    {% else %}
        <p>Nenhum resultado encontrado.</p>
    {% endif %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/php.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre code').forEach((block) => {
                // Forçar highlight para linguagens específicas
                const languageClass = Array.from(block.classList)
                    .find(cls => cls.startsWith('language-'));
                
                if (languageClass) {
                    const language = languageClass.replace('language-', '');
                    block.classList.add('hljs');
                    hljs.highlightElement(block);
                } else {
                    // Tentar detectar linguagem automaticamente
                    hljs.highlightElement(block);
                }
            });
        });
    </script>
</body>
</html>
